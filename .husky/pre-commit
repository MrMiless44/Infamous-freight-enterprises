#!/usr/bin/env sh
set -eu

# Resolve repo root relative to this script so it works from any CWD
REPO_ROOT="$(cd -- "$(dirname "$0")/.." && pwd -P)"

# Check for npm/yarn lockfiles (must happen before any staging)
check_lockfiles() {
  echo "ğŸ” Checking for npm/yarn lockfiles..."
  if [ -f "$REPO_ROOT/scripts/validation/check-lockfiles.sh" ]; then
    (cd "$REPO_ROOT" && bash scripts/validation/check-lockfiles.sh)
  else
    # Fallback check if script doesn't exist
    if [ -f "$REPO_ROOT/package-lock.json" ] || git ls-files '**/package-lock.json' | grep -q . || [ -f "$REPO_ROOT/yarn.lock" ]; then
      echo "âŒ Error: npm/yarn lockfiles detected. This project uses pnpm only."
      exit 1
    fi
  fi
}

# Ensure pnpm is available (prefer Corepack) and fall back to npx/npm
ensure_pnpm() {
  if command -v pnpm >/dev/null 2>&1; then
    if pnpm --version >/dev/null 2>&1; then
      return 0
    fi
  fi
  if command -v corepack >/dev/null 2>&1; then
    corepack enable >/dev/null 2>&1 || true
    corepack prepare pnpm@8.15.9 --activate >/dev/null 2>&1 || true
  fi
  pnpm --version >/dev/null 2>&1
}

run_lint_staged() {
  echo "ğŸ” Running lint-staged..."
  if ensure_pnpm; then
    (cd "$REPO_ROOT" && pnpm lint-staged)
  else
    echo "âŒ pnpm not found. Install with: corepack enable && corepack prepare pnpm@8.15.9 --activate"
    exit 1
  fi
}

# Run checks in order
if ! check_lockfiles; then
  echo "âŒ Lockfile check failed. Commit aborted."
  exit 1
fi

if run_lint_staged; then
  echo "âœ… Pre-commit checks passed!"
else
  echo "âŒ Lint-staged checks failed. Commit aborted."
  exit 1
fi
