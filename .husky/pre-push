#!/usr/bin/env sh
set -euo pipefail

# Pre-push hook - Run tests and type checks before pushing
echo "üß™ Running pre-push checks..."

# Resolve repo root relative to this script so it works from any CWD
REPO_ROOT="$(cd -- "$(dirname "$0")/.." && pwd -P)"

# Ensure pnpm is available (prefer Corepack) and fall back to npm if needed
ensure_pnpm() {
  if command -v pnpm >/dev/null 2>&1; then
    # Verify pnpm actually works; if not, try to repair via corepack
    if pnpm --version >/dev/null 2>&1; then
      return 0
    fi
  fi
  if command -v corepack >/dev/null 2>&1; then
    corepack enable >/dev/null 2>&1 || true
    corepack prepare pnpm@8.15.9 --activate >/dev/null 2>&1 || true
  fi
  pnpm --version >/dev/null 2>&1
}

run_type_check() {
  echo "‚úçÔ∏è  Type checking..."
  if ensure_pnpm; then
    (cd "$REPO_ROOT" && pnpm typecheck) || {
      echo "‚ùå Type check failed. Fix TypeScript errors before pushing."
      return 1
    }
  else
    echo "‚ö†Ô∏è  pnpm unavailable; skipping type check"
  fi
}

RUN_API_TESTS() {
  echo "üì¶ Running API tests..."
  if ensure_pnpm; then
    # Pass Jest flags after -- so pnpm forwards them to the script
    (cd "$REPO_ROOT/src/apps/api" && pnpm test -- --bail --maxWorkers=50%)
  else
    echo "‚ö†Ô∏è pnpm unavailable; using npm fallback for API tests"
    (cd "$REPO_ROOT/src/apps/api" && npm test --silent)
  fi
}

if run_type_check && RUN_API_TESTS; then
  echo "‚úÖ All pre-push checks passed. Pushing..."
else
  echo "‚ùå Pre-push checks failed. Fix issues before pushing."
  exit 1
fi
