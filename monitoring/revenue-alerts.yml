# Revenue System Monitoring Alerts

alerts:
  # Critical Alerts (PagerDuty)
  - name: high_payment_failure_rate
    condition: payment_failure_rate > 0.10
    severity: critical
    notification: pagerduty
    message: "Payment failure rate above 10%"
    runbook: "REVENUE_OPERATIONS_RUNBOOK.md#mass-payment-failures"

  - name: email_delivery_failure
    condition: email_delivery_rate < 0.90
    severity: critical
    notification: pagerduty
    message: "Email delivery rate below 90%"
    runbook: "REVENUE_OPERATIONS_RUNBOOK.md#email-service-down"

  - name: api_error_rate_high
    condition: api_error_rate > 0.05
    severity: critical
    notification: pagerduty
    message: "API error rate above 5%"

  # High Priority Alerts (Slack)
  - name: high_churn_rate
    condition: churn_rate > 0.20
    severity: high
    notification: slack
    channel: "#revenue-alerts"
    message: "Churn rate above 20%"

  - name: low_conversion_rate
    condition: conversion_rate < 0.08
    severity: high
    notification: slack
    channel: "#revenue-alerts"
    message: "Conversion rate below 8%"

  - name: mrr_declined
    condition: mrr_week_over_week_change < -0.05
    severity: high
    notification: slack
    channel: "#revenue-alerts"
    message: "MRR declined >5% week-over-week"

  # Medium Priority Alerts (Email)
  - name: trial_signup_decline
    condition: trial_signups_week_over_week < -0.20
    severity: medium
    notification: email
    recipients: ["growth@infamousfreight.com"]
    message: "Trial signups declined >20% week-over-week"

  - name: webhook_processing_delay
    condition: webhook_processing_time > 5000
    severity: medium
    notification: email
    recipients: ["engineering@infamousfreight.com"]
    message: "Webhook processing time >5s"

  # Info Notifications (Slack)
  - name: mrr_milestone
    condition: mrr in [5000, 10000, 25000, 50000, 100000]
    severity: info
    notification: slack
    channel: "#celebrations"
    message: "ðŸŽ‰ MRR milestone reached: ${{mrr}}"

  - name: customer_milestone
    condition: active_customers in [25, 50, 100, 250, 500, 1000]
    severity: info
    notification: slack
    channel: "#celebrations"
    message: "ðŸŽ‰ Customer milestone: {{active_customers}} active customers!"

# Monitoring Queries
queries:
  payment_failure_rate:
    sql: |
      SELECT 
        CAST(COUNT(*) FILTER (WHERE "eventType" = 'payment_failed') AS FLOAT) / 
        NULLIF(COUNT(*) FILTER (WHERE "eventType" IN ('payment_succeeded', 'payment_failed')), 0)
      FROM "RevenueEvent"
      WHERE "createdAt" > NOW() - INTERVAL '1 day';
    schedule: "*/15 * * * *" # Every 15 minutes

  email_delivery_rate:
    sql: |
      SELECT delivery_rate 
      FROM email_stats 
      WHERE date = CURRENT_DATE;
    schedule: "0 * * * *" # Every hour

  churn_rate:
    sql: |
      SELECT 
        CAST(COUNT(*) FILTER (WHERE "cancelledAt" > NOW() - INTERVAL '30 days') AS FLOAT) / 
        NULLIF(COUNT(*), 0) * 100
      FROM "Subscription"
      WHERE "createdAt" < NOW() - INTERVAL '30 days';
    schedule: "0 0 * * *" # Daily

  conversion_rate:
    sql: |
      SELECT 
        CAST(COUNT(*) FILTER (WHERE "isOnTrial" = false) AS FLOAT) / 
        NULLIF(COUNT(*), 0) * 100
      FROM "Subscription";
    schedule: "0 */6 * * *" # Every 6 hours

  mrr:
    sql: |
      SELECT SUM("priceMonthly") 
      FROM "Subscription" 
      WHERE status = 'active' 
        AND "isOnTrial" = false;
    schedule: "0 */6 * * *" # Every 6 hours
