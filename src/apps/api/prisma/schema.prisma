generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Connection pooling via PgBouncer (recommended for production)
  // Set DATABASE_URL with ?pgbouncer=true&connection_limit=50
}

model Organization {
  id            String      @id @default(cuid())
  name          String
  users         User[]
  webhooks      Webhook[]
  subscriptions Subscription[]
  createdAt     DateTime    @default(now())
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  passwordHash   String
  firstName      String?
  lastName       String?
  phone          String?
  role           String
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id])
  customer       Customer?      @relation("CustomerUser")
  driver         Driver?        @relation("DriverUser")
  twoFactorAuth  TwoFactorAuth?
  createdAt      DateTime       @default(now())
}

model AiDecision {
  id             String   @id @default(cuid())
  organizationId String
  type           String
  confidence     Float
  rationale      String
  createdAt      DateTime @default(now())
}

model DriverProfile {
  id             String   @id @default(cuid())
  userId         String   @unique
  organizationId String
  displayName    String
  avatarTheme    String
}

model AvatarMemory {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  category       String
  key            String
  value          String
  confidence     Float
  pinned         Boolean  @default(false)
  createdAt      DateTime @default(now())
}

model RouteSession {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  startedAt      DateTime @default(now())
  endedAt        DateTime?
}

model RouteEvent {
  id        String   @id @default(cuid())
  sessionId String
  type      String
  meta      String
  createdAt DateTime @default(now())
}

model Customer {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation("CustomerUser", fields: [userId], references: [id])
  organizationId String
  companyName    String?
  loads          Load[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Driver {
  id                   String              @id @default(cuid())
  userId               String              @unique
  user                 User                @relation("DriverUser", fields: [userId], references: [id])
  organizationId       String
  licenseNumber        String
  isAvailable          Boolean             @default(true)
  currentLocation      Json?
  loads                Load[]
  aiCoachingSessions   AICoachingSession[]
  predictions          DriverPrediction[]
  locationHistory      LocationHistory[]
  points               GamificationPoints[]
  badges               Badge[]
  leaderboard          Leaderboard[]
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  // Phase 2 Performance Optimization - Driver availability index
  @@index([isAvailable])               // idx_drivers_available: Availability filtering
}

model Vehicle {
  id                String           @id @default(cuid())
  organizationId    String
  vehicleNumber     String           @unique
  make              String
  model             String
  year              Int
  vin               String           @unique
  status            String           @default("AVAILABLE")
  mileage           Float            @default(0)
  lastMaintenance   DateTime?
  nextMaintenance   DateTime?
  maintenanceLogs   MaintenanceLog[]
  loads             Load[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
}

model Load {
  id              String        @id @default(cuid())
  loadNumber      String        @unique
  organizationId  String
  customerId      String
  customer        Customer      @relation(fields: [customerId], references: [id])
  driverId        String?
  driver          Driver?       @relation(fields: [driverId], references: [id])
  vehicleId       String?
  vehicle         Vehicle?      @relation(fields: [vehicleId], references: [id])
  pickupAddress   String
  pickupLat       Float
  pickupLng       Float
  deliveryAddress String
  deliveryLat     Float
  deliveryLng     Float
  pickupTime      DateTime
  deliveryTime    DateTime
  weight          Float
  rate            Float
  description     String?
  status          String        @default("PENDING")
  rating          Float?
  aiDecisions     AIDecision[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Phase 2 Performance Optimization - 6 Critical Indexes
  @@index([status])                    // idx_loads_status: Status filtering
  @@index([driverId])                  // idx_loads_driver_id: Driver lookups
  @@index([createdAt(sort: Desc)])     // idx_loads_created_at: Time-based queries
  @@index([driverId, status])          // idx_loads_driver_status: Composite queries
}

model AIDecision {
  id            String   @id @default(cuid())
  loadId        String
  load          Load     @relation(fields: [loadId], references: [id])
  aiRole        String
  decision      String
  reasoning     String
  confidence    Float
  humanApproved Boolean  @default(false)
  createdAt     DateTime @default(now())
}

model AICoachingSession {
  id          String   @id @default(cuid())
  driverId    String
  driver      Driver   @relation(fields: [driverId], references: [id])
  feedback    String
  metrics     Json
  suggestions Json
  createdAt   DateTime @default(now())
}

model MaintenanceLog {
  id          String    @id @default(cuid())
  vehicleId   String
  vehicle     Vehicle   @relation(fields: [vehicleId], references: [id])
  type        String
  description String
  cost        Float
  performedAt DateTime  @default(now())
  nextDue     DateTime?
  createdAt   DateTime  @default(now())
}

model Notification {
  id            String   @id @default(cuid())
  userId        String
  type          String
  title         String
  message       String
  isRead        Boolean  @default(false)
  emailTo       String?
  phoneTo       String?
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([isRead, createdAt])
}

model Message {
  id            String   @id @default(cuid())
  senderId      String
  recipientId   String?
  content       String
  type          String
  isRead        Boolean  @default(false)
  relatedId     String?
  relatedType   String?
  createdAt     DateTime @default(now())

  @@index([senderId])
  @@index([recipientId])
  @@index([isRead, createdAt])
}

model Webhook {
  id              String       @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  event           String
  url             String
  secret          String
  isActive        Boolean      @default(true)
  maxRetries      Int          @default(3)
  headers         Json?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  lastTriggered   DateTime?

  @@index([organizationId])
  @@index([event])
}

// Phase 3 Feature 1: Predictive Driver Availability
model DriverPrediction {
  id              String   @id @default(cuid())
  driverId        String
  driver          Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  availabilityScore Float  // 0.0 to 1.0
  confidence      Float    // Model confidence in prediction
  factors         Json     // {timeOfDay, dayOfWeek, weather, traffic, recentActivity, historical}
  recommendation  String   // HIGH, MEDIUM, LOW
  metadata        Json?    // Additional context
  createdAt       DateTime @default(now())

  @@index([driverId])
  @@index([createdAt(sort: Desc)])
  @@index([recommendation])
}

// Phase 3 Feature 2: Route Optimization
model RouteOptimization {
  id              String   @id @default(cuid())
  waypoints       Json     // Original waypoints
  optimizedPath   Json     // Optimized sequence
  totalDistance   Float    // km
  estimatedTime   Int      // minutes
  efficiency      Float    // percentage improvement
  fuelEstimate    Float    // liters
  costEstimate    Float    // currency
  metadata        Json?    // {loadIds, timestamp}
  createdAt       DateTime @default(now())

  @@index([createdAt(sort: Desc)])
}

// Phase 3 Feature 3: Real-time GPS Tracking
model LocationHistory {
  id              String   @id @default(cuid())
  driverId        String
  driver          Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  latitude        Float
  longitude       Float
  speed           Float    // km/h
  heading         Float    // 0-360 degrees
  accuracy        Float    // meters
  timestamp       DateTime
  createdAt       DateTime @default(now())

  @@index([driverId])
  @@index([timestamp(sort: Desc)])
  @@index([driverId, timestamp])
}

// Phase 3 Feature 3: Geofencing
model Geofence {
  id              String   @id @default(cuid())
  organizationId  String
  name            String
  type            String   // pickup, delivery, warehouse, restricted
  latitude        Float
  longitude       Float
  radiusMeters    Float
  alertOnEntry    Boolean  @default(true)
  alertOnExit     Boolean  @default(true)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([type])
}

// Phase 3 Feature 4: Gamification System
model GamificationPoints {
  id              String   @id @default(cuid())
  driverId        String
  driver          Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  points          Int
  category        String   // on-time, safety, efficiency, customer-rating
  metadata        Json?    // Reference to related load/event
  createdAt       DateTime @default(now())

  @@index([driverId])
  @@index([category])
}

model Badge {
  id              String   @id @default(cuid())
  driverId        String
  driver          Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  badgeType       String   // GOLD_STAR, PERFECT_RECORD, SPEED_DEMON, SAFETY_FIRST, etc
  earnedAt        DateTime @default(now())
  metadata        Json?

  @@index([driverId])
  @@index([badgeType])
}

model Leaderboard {
  id              String   @id @default(cuid())
  driverId        String
  driver          Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  totalPoints     Int      @default(0)
  rank            Int
  period          String   // daily, weekly, monthly, all-time
  lastUpdated     DateTime @updatedAt
  createdAt       DateTime @default(now())

  @@index([driverId])
  @@index([rank])
  @@index([period])
}

// Phase 3 Feature 6: Business Metrics Dashboard
model BusinessMetric {
  id              String   @id @default(cuid())
  organizationId  String
  metricType      String   // revenue, efficiency, customer-satisfaction, driver-retention
  value           Float
  previousValue   Float?
  changePercent   Float?
  period          String   // daily, weekly, monthly
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([organizationId])
  @@index([metricType])
  @@index([period])
}

// Phase 3 Feature 7: Enhanced Security - 2FA
model TwoFactorAuth {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  secret          String   // Encrypted TOTP secret
  backupCodes     Json     // Hashed backup codes array
  enabled         Boolean  @default(false)
  smsPhone        String?  // Optional SMS verification number
  lastVerified    DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([enabled])
}

// Billing & Revenue Models
model Subscription {
  id                String    @id @default(cuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Stripe/PayPal info
  stripeCustomerId  String?
  stripeSubId       String?   @unique
  paypalSubId       String?   @unique
  paymentMethod     String    @default("stripe") // "stripe" | "paypal"
  
  // Pricing tier
  tier              String    @default("starter") // "starter" | "professional" | "enterprise"
  priceMonthly      Float
  billingCycle      String    @default("monthly") // "monthly" | "annual"
  
  // Trial
  trialEndsAt       DateTime?
  isOnTrial         Boolean   @default(true)
  
  // Status
  status            String    @default("active") // "active" | "paused" | "cancelled" | "past_due"
  cancelledAt       DateTime?
  
  // Dates
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  invoices          Invoice[]
  revenueEvents     RevenueEvent[]
  
  @@index([organizationId])
  @@index([stripeCustomerId])
  @@index([status])
  @@index([tier])
}

model Invoice {
  id                String    @id @default(cuid())
  subscriptionId    String
  subscription      Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  organizationId    String
  
  // Amount
  amount            Float
  currency          String    @default("usd")
  
  // Stripe/PayPal IDs
  stripeInvoiceId   String?   @unique
  paypalInvoiceId   String?   @unique
  
  // Status
  status            String    @default("draft") // "draft" | "sent" | "paid" | "failed" | "void"
  paidAt            DateTime?
  
  // Line items
  items             Json      // Array of {description, amount, quantity}
  
  // Metadata
  invoiceNumber     String
  dueDate           DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([subscriptionId])
  @@index([organizationId])
  @@index([status])
  @@unique([organizationId, invoiceNumber])
}

model RevenueEvent {
  id                String    @id @default(cuid())
  subscriptionId    String
  subscription      Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  organizationId    String
  
  // Event type
  eventType         String    // "trial_started" | "subscription_created" | "payment_succeeded" | "payment_failed" | "subscription_updated" | "subscription_cancelled" | "upgrade" | "downgrade"
  
  // Amount
  amount            Float?
  
  // Details
  description       String?
  metadata          Json?
  
  // Timestamps
  createdAt         DateTime  @default(now())
  
  @@index([subscriptionId])
  @@index([organizationId])
  @@index([eventType])
  @@index([createdAt])
}
