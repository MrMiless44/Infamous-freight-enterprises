name: HTML Quality Validation

on:
  pull_request:
    paths:
      - '**.html'
  push:
    branches: ["main"]
    paths:
      - '**.html'
  workflow_dispatch:

jobs:
  html-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show repo tree (for debugging)
        run: |
          mkdir -p ci-logs
          echo "Repository root:" | tee ci-logs/root.txt
          ls -la | tee -a ci-logs/root.txt
          echo "Top-level HTML files:" | tee -a ci-logs/root.txt
          ls -la *.html 2>&1 | tee -a ci-logs/root.txt || true

      - name: Install html tidy (libtidy)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update -y
          sudo apt-get install -y tidy
          tidy -v || true

      - name: Validate HTML files with tidy
        env:
          HTML_ROOT: .
        run: |
          set -o pipefail
          mkdir -p ci-logs
          # Search up to 6 directory levels deep for HTML files
          mapfile -t HTML_FILES < <(find "$HTML_ROOT" -maxdepth 6 -type f -name "*.html" \
            -not -path "*/node_modules/*" \
            -not -path "*/dist/*" \
            -not -path "*/build/*" \
            -not -path "*/.git/*")
          if [ ${#HTML_FILES[@]} -eq 0 ]; then
            echo "No HTML files found; nothing to validate." | tee ci-logs/tidy.log
            exit 0
          fi
          echo "HTML files found: ${HTML_FILES[*]}" | tee ci-logs/tidy.log
          ERR=0
          for f in "${HTML_FILES[@]}"; do
            echo "Validating $f" | tee -a ci-logs/tidy.log
            if [ -f ".tidyrc" ]; then
              tidy -e -q -utf8 -config .tidyrc "$f" 2>&1 | tee -a ci-logs/tidy.log || ERR=1
            else
              tidy -e -q -utf8 "$f" 2>&1 | tee -a ci-logs/tidy.log || ERR=1
            fi
          done
          if [ $ERR -ne 0 ]; then
            echo "::error::One or more HTML files failed tidy validation." | tee -a ci-logs/tidy.log
            exit 1
          fi
        # If you prefer non-blocking validation, uncomment:
        # continue-on-error: true

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: ci-logs
