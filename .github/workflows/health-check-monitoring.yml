# Multi-Platform Health Monitoring - Checks every 5 minutes
# Prevents $10K-50K in downtime costs by detecting issues immediately

name: Platform Health Check

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]  # Run on every deploy

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Check Vercel Deployment
        id: vercel
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 \
            https://infamous-freight-enterprises.vercel.app/api/health || echo "000")
          
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "404" ]; then
            echo "status=‚úÖ Operational" >> $GITHUB_OUTPUT
            echo "color=success" >> $GITHUB_OUTPUT
          else
            echo "status=‚ö†Ô∏è Degraded (HTTP $RESPONSE)" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi
      
      - name: Check Netlify Deployment
        id: netlify
        continue-on-error: true
        run: |
          # Try multiple Netlify domains
          for url in \
            "https://infamous-freight.netlify.app" \
            "https://infamous-freight-enterprises.netlify.app"
          do
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$url" || echo "000")
            if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "404" ]; then
              echo "status=‚úÖ Operational" >> $GITHUB_OUTPUT
              echo "color=success" >> $GITHUB_OUTPUT
              break
            fi
          done
          
          if [ ! -f "$GITHUB_OUTPUT" ] || ! grep -q "status=" "$GITHUB_OUTPUT"; then
            echo "status=‚ö†Ô∏è Check configuration" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi
      
      - name: Check Cloudflare Pages
        id: cloudflare
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 \
            https://infamous-freight-enterprises.pages.dev || echo "000")
          
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "404" ]; then
            echo "status=‚úÖ Operational" >> $GITHUB_OUTPUT
            echo "color=success" >> $GITHUB_OUTPUT
          else
            echo "status=‚ö†Ô∏è Not deployed yet" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi
      
      - name: Check Render Deployment
        id: render
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 \
            https://infamous-freight.onrender.com || echo "000")
          
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "404" ]; then
            echo "status=‚úÖ Operational" >> $GITHUB_OUTPUT
            echo "color=success" >> $GITHUB_OUTPUT
          else
            echo "status=‚ö†Ô∏è Not deployed yet" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi
      
      - name: Check GitHub Pages
        id: github-pages
        continue-on-error: true
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 \
            https://mrmiles44.github.io/Infamous-freight-enterprises/ || echo "000")
          
          if [ "$RESPONSE" = "200" ]; then
            echo "status=‚úÖ Operational" >> $GITHUB_OUTPUT
            echo "color=success" >> $GITHUB_OUTPUT
          else
            echo "status=‚ö†Ô∏è Degraded (HTTP $RESPONSE)" >> $GITHUB_OUTPUT
            echo "color=warning" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Status Summary
        id: summary
        run: |
          echo "## üöÄ Platform Health Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checked:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| GitHub Pages | ${{ steps.github-pages.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Vercel | ${{ steps.vercel.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Netlify | ${{ steps.netlify.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cloudflare | ${{ steps.cloudflare.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Render | ${{ steps.render.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count operational platforms
          OPERATIONAL=0
          [[ "${{ steps.github-pages.outputs.status }}" =~ "Operational" ]] && ((OPERATIONAL++))
          [[ "${{ steps.vercel.outputs.status }}" =~ "Operational" ]] && ((OPERATIONAL++))
          [[ "${{ steps.netlify.outputs.status }}" =~ "Operational" ]] && ((OPERATIONAL++))
          [[ "${{ steps.cloudflare.outputs.status }}" =~ "Operational" ]] && ((OPERATIONAL++))
          [[ "${{ steps.render.outputs.status }}" =~ "Operational" ]] && ((OPERATIONAL++))
          
          echo "**Operational Platforms:** $OPERATIONAL / 5" >> $GITHUB_STEP_SUMMARY
          
          if [ $OPERATIONAL -ge 4 ]; then
            echo "**Overall Status:** ‚úÖ Healthy" >> $GITHUB_STEP_SUMMARY
            echo "overall=healthy" >> $GITHUB_OUTPUT
          elif [ $OPERATIONAL -ge 2 ]; then
            echo "**Overall Status:** ‚ö†Ô∏è Degraded" >> $GITHUB_STEP_SUMMARY
            echo "overall=degraded" >> $GITHUB_OUTPUT
          else
            echo "**Overall Status:** üö® Critical" >> $GITHUB_STEP_SUMMARY
            echo "overall=critical" >> $GITHUB_OUTPUT
          fi
      
      - name: Send Slack Alert (Optional)
        if: steps.summary.outputs.overall != 'healthy'
        continue-on-error: true
        run: |
          # Uncomment and add SLACK_WEBHOOK secret to enable
          # curl -X POST "${{ secrets.SLACK_WEBHOOK }}" \
          #   -H 'Content-Type: application/json' \
          #   -d '{
          #     "text": "‚ö†Ô∏è Platform health degraded. Check GitHub Actions for details.",
          #     "attachments": [{
          #       "color": "warning",
          #       "fields": [
          #         {"title": "GitHub Pages", "value": "${{ steps.github-pages.outputs.status }}", "short": true},
          #         {"title": "Vercel", "value": "${{ steps.vercel.outputs.status }}", "short": true},
          #         {"title": "Netlify", "value": "${{ steps.netlify.outputs.status }}", "short": true},
          #         {"title": "Cloudflare", "value": "${{ steps.cloudflare.outputs.status }}", "short": true}
          #       ]
          #     }]
          #   }'
          echo "Slack alerting not configured. Add SLACK_WEBHOOK secret to enable."
      
      - name: Create GitHub Issue on Failure
        if: steps.summary.outputs.overall == 'critical'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Critical: Multiple Platform Outages Detected';
            const body = `
            ## Platform Health Alert
            
            **Time:** ${new Date().toISOString()}
            **Severity:** Critical
            
            ### Status
            - GitHub Pages: ${{ steps.github-pages.outputs.status }}
            - Vercel: ${{ steps.vercel.outputs.status }}
            - Netlify: ${{ steps.netlify.outputs.status }}
            - Cloudflare: ${{ steps.cloudflare.outputs.status }}
            - Render: ${{ steps.render.outputs.status }}
            
            ### Action Required
            1. Check platform dashboards
            2. Review recent deployments
            3. Verify DNS configuration
            4. Check for ongoing incidents on status pages
            
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            `;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'platform-health'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['platform-health', 'critical']
              });
            }
