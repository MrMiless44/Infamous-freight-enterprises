name: Auto PR for Test Fixes

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-auto-fix-pr:
    name: Create PR when tests can be auto-fixed
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'failure' &&
       github.event.workflow_run.event == 'push' &&
       github.event.workflow_run.head_branch == 'main' &&
       github.event.workflow_run.head_repository.full_name == github.repository)
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.ref }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Enable corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Run tests (allow failure)
        id: initial-tests
        run: pnpm -r --if-present test
        continue-on-error: true

      - name: Skip auto-fix when tests already pass
        if: steps.initial-tests.outcome == 'success'
        run: echo "Tests already passing; no automated fix required."

      - name: Attempt automated test fix
        id: autofix
        if: steps.initial-tests.outcome == 'failure'
        run: |
          set -euo pipefail
          chmod +x scripts/auto-fix-tests.sh
          scripts/auto-fix-tests.sh
        continue-on-error: true

      - name: Determine git changes
        id: changes
        if: steps.initial-tests.outcome == 'failure'
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            git status --short
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create pull request with fixes
        if: |
          steps.initial-tests.outcome == 'failure' &&
          steps.autofix.outcome == 'success' &&
          steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          branch: ci/test-autofix-${{ github.run_id }}
          title: "chore: auto-fix tests after CI failure"
          commit-message: "chore: auto-fix tests after CI failure"
          body: |
            Automated test fix generated by CI after detecting failing tests.
            - Trigger: ${{ github.event_name == 'workflow_run' && format('CI run {0}', github.event.workflow_run.html_url) || 'manual dispatch' }}
            - Actions: lint fixes, snapshot updates, and re-run of workspace tests.
          labels: |
            automated
            ci-fix

      - name: Fail when auto-fix cannot resolve tests
        if: |
          steps.initial-tests.outcome == 'failure' &&
          (steps.autofix.outcome != 'success' || steps.changes.outputs.has_changes != 'true')
        run: |
          echo "Automated fixes did not resolve tests or produce changes."
          exit 1
