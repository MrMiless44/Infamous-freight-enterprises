name: Auto Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - 'archive/**'
      - 'docs/**'
      - '**.md'
      - '.vscode/**'
  workflow_dispatch:
    inputs:
      deploy_api:
        description: 'Deploy API to Fly.io'
        type: boolean
        default: true
      deploy_web:
        description: 'Deploy Web to Vercel'
        type: boolean
        default: true

permissions:
  contents: read
  deployments: write

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api_changed: ${{ steps.changes.outputs.api }}
      web_changed: ${{ steps.changes.outputs.web }}
      mobile_changed: ${{ steps.changes.outputs.mobile }}
      shared_changed: ${{ steps.changes.outputs.shared }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changes
        id: changes
        run: |
          # Check if specific paths changed
          API_CHANGED=$(git diff --name-only HEAD^ HEAD | grep -E '^(src/apps/api|api)/' || echo "")
          WEB_CHANGED=$(git diff --name-only HEAD^ HEAD | grep -E '^(src/apps/web|web)/' || echo "")
          MOBILE_CHANGED=$(git diff --name-only HEAD^ HEAD | grep -E '^(src/apps/mobile|mobile)/' || echo "")
          SHARED_CHANGED=$(git diff --name-only HEAD^ HEAD | grep -E '^(src/packages/shared|packages)/' || echo "")
          
          # Manual trigger overrides
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "api=${{ inputs.deploy_api }}" >> $GITHUB_OUTPUT
            echo "web=${{ inputs.deploy_web }}" >> $GITHUB_OUTPUT
            echo "mobile=true" >> $GITHUB_OUTPUT
            echo "shared=true" >> $GITHUB_OUTPUT
          else
            # Set outputs based on changes
            if [ -n "$API_CHANGED" ] || [ -n "$SHARED_CHANGED" ]; then
              echo "api=true" >> $GITHUB_OUTPUT
            else
              echo "api=false" >> $GITHUB_OUTPUT
            fi
            
            if [ -n "$WEB_CHANGED" ] || [ -n "$SHARED_CHANGED" ]; then
              echo "web=true" >> $GITHUB_OUTPUT
            else
              echo "web=false" >> $GITHUB_OUTPUT
            fi
            
            if [ -n "$MOBILE_CHANGED" ] || [ -n "$SHARED_CHANGED" ]; then
              echo "mobile=true" >> $GITHUB_OUTPUT
            else
              echo "mobile=false" >> $GITHUB_OUTPUT
            fi
            
            echo "shared=${SHARED_CHANGED:+true}" >> $GITHUB_OUTPUT
            echo "shared=${SHARED_CHANGED:-false}" >> $GITHUB_OUTPUT
          fiMobile Changed: ${{ steps.changes.outputs.mobile }}"
          echo "- 

      - name: Show detected changes
        run: |
          echo "ðŸ” Change Detection Results:"
          echo "- API Changed: ${{ steps.changes.outputs.api }}"
          echo "- Web Changed: ${{ steps.changes.outputs.web }}"
          echo "- Shared Changed: ${{ steps.changes.outputs.shared }}"

  ci:
    name: Run CI
    need|
      needs.detect-changes.outputs.api_changed == 'true' || 
      needs.detect-changes.outputs.web_changed == 'true' ||
      needs.detect-changes.outputs.mobile
    if: needs.detect-changes.outputs.api_changed == 'true' || needs.detect-changes.outputs.web_changed == 'true'
    uses: ./.github/workflows/ci.yml

  check-secrets:
    name: Check Deployment Credentials
    runs-on: ubuntu-latest
      has-expo-token: ${{ steps.check.outputs.has-expo-token }}
    steps:
      - name: Check secrets
        id: check
        run: |
          if [ -n "${{ secrets.FLY_API_TOKEN }}" ]; then
            echo "has-fly-token=true" >> $GITHUB_OUTPUT
            echo "âœ… Fly.io token configured"
          else
            echo "has-fly-token=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  FLY_API_TOKEN not configured"
          fi
          
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "has-vercel-token=true" >> $GITHUB_OUTPUT
            echo "âœ… Vercel token configured"
          else
            echo "has-vercel-token=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  VERCEL_TOKEN not configured"
          fi
          
          if [ -n "${{ secrets.EXPO_TOKEN }}" ]; then
            echo "has-expo-token=true" >> $GITHUB_OUTPUT
            echo "âœ… Expo token configured"
          else
            echo "has-expo-token=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  EXPOoken configured"
          else
            echo "has-vercel-token=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  VERCEL_TOKEN not configured"
          fi

  deploy-api:
    name: Deploy API
    needs: [detect-changes, ci, check-secrets]
    if: |
      needs.detect-changes.outputs.api_changed == 'true' && 
      needs.check-secrets.outputs.has-fly-token == 'true' &&
      needs.ci.result == 'success'
    uses: ./.github/workflows/fly-deploy.yml
    secrets: inherit


  deploy-mobile:
    name: Deploy Mobile
    needs: [detect-changes, ci, check-secrets]
    if: |
      needs.detect-changes.outputs.mobile_changed == 'true' && 
      needs.check-secrets.outputs.has-expo-token == 'true' &&
      needs.ci.result == 'success'
    uses: ./.github/workflows/mobile-deploy.yml
    secrets: inherit
  deploy-web:
    name: Deploy Web
    needs: [detect-changes, ci, check-secrets], deploy-mobile]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Detected" >> $GITHUB_STEP_SUMMARY
          echo "- API: ${{ needs.detect-changes.outputs.api_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Web: ${{ needs.detect-changes.outputs.web_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Mobile: ${{ needs.detect-changes.outputs.mobile_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- Shared: ${{ needs.detect-changes.outputs.shared_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Results" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.detect-changes.outputs.api_changed }}" = "true" ]; then
            if [ "${{ needs.deploy-api.result }}" = "success" ]; then
              echo "âœ… API deployed successfully to Fly.io" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy-api.result }}" = "skipped" ]; then
              echo "â­ï¸  API deployment skipped (no credentials)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ API deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸  API deployment skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.web_changed }}" = "true" ]; then
            if [ "${{ needs.deploy-web.result }}" = "success" ]; then
              echo "âœ… Web deployed successfully to Vercel" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy-web.result }}" = "skipped" ]; then
              echo "â­ï¸  Web deployment skipped (no credentials)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Web deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸  Web deployment skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.detect-changes.outputs.mobile_changed }}" = "true" ]; then
            if [ "${{ needs.deploy-mobile.result }}" = "success" ]; then
              echo "âœ… Mobile deployed successfully to Expo EAS" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.deploy-mobile.result }}" = "skipped" ]; then
              echo "â­ï¸  Mobile deployment skipped (no credentials)" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Mobile deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸  Mobile deployment skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Web: https://infamous-freight-enterprises.vercel.app" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”Œ API: https://infamous-freight-api.fly.dev" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± Mobile: https://expo.dev/@infamous-freight/mobile
              echo "âŒ Web deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸  Web deployment skipped (no changes)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ Web: https://infamous-freight-enterprises.vercel.app" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”Œ API: https://infamous-freight-api.fly.dev" >> $GITHUB_STEP_SUMMARY
