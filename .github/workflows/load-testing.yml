name: Load Testing

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "Environment to test"
        required: true
        type: choice
        options:
          - staging
          - production
      test_type:
        description: "Test scenario"
        required: false
        type: choice
        default: "load"
        options:
          - load
          - stress
          - spike
          - soak
      duration:
        description: "Test duration (seconds)"
        required: false
        default: "60"
      vus:
        description: "Virtual users"
        required: false
        default: "50"

jobs:
  load-test-api:
    name: Load Test API
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Set target URL
        id: target
        run: |
          if [ "${{ inputs.target_env }}" == "production" ]; then
            echo "url=https://infamous-freight-api.fly.dev" >> $GITHUB_OUTPUT
          else
            echo "url=https://infamous-freight-enterprises-api.onrender.com" >> $GITHUB_OUTPUT
          fi

      - name: Create k6 test script
        run: |
          TEST_TYPE="${{ inputs.test_type }}"

          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          import { Rate } from 'k6/metrics';

          const errorRate = new Rate('errors');
          const TEST_TYPE = __ENV.TEST_TYPE || 'load';

          // Configure test scenarios based on type
          const scenarios = {
            load: {
              stages: [
                { duration: '30s', target: __ENV.VUS || 50 },  // Ramp up
                { duration: '${DURATION}s', target: __ENV.VUS || 50 },  // Stay at peak
                { duration: '30s', target: 0 },   // Ramp down
              ],
              thresholds: {
                http_req_duration: ['p(95)<500', 'p(99)<1000'],
                http_req_failed: ['rate<0.05'],
                errors: ['rate<0.05'],
              },
            },
            stress: {
              stages: [
                { duration: '2m', target: 100 },  // Ramp up to normal load
                { duration: '5m', target: 100 },  // Stay at normal load
                { duration: '2m', target: 200 },  // Ramp up to stress load
                { duration: '5m', target: 200 },  // Stay at stress load
                { duration: '2m', target: 300 },  // Ramp up to breaking point
                { duration: '5m', target: 300 },  // Stay at breaking point
                { duration: '5m', target: 0 },    // Ramp down
              ],
              thresholds: {
                http_req_duration: ['p(95)<1000', 'p(99)<2000'],
                http_req_failed: ['rate<0.10'],  // Allow higher error rate
              },
            },
            spike: {
              stages: [
                { duration: '1m', target: 50 },   // Normal load
                { duration: '10s', target: 500 }, // Spike!
                { duration: '3m', target: 500 },  // Sustain spike
                { duration: '10s', target: 50 },  // Drop back
                { duration: '1m', target: 50 },   // Recover
                { duration: '10s', target: 0 },   // Ramp down
              ],
              thresholds: {
                http_req_duration: ['p(95)<2000'],
                http_req_failed: ['rate<0.15'],  // Allow even higher error rate
              },
            },
            soak: {
              stages: [
                { duration: '5m', target: 100 },   // Ramp up
                { duration: '3h', target: 100 },   // Soak for 3 hours
                { duration: '5m', target: 0 },     // Ramp down
              ],
              thresholds: {
                http_req_duration: ['p(95)<500', 'p(99)<1000'],
                http_req_failed: ['rate<0.05'],
              },
            },
          };

          export const options = scenarios[TEST_TYPE];

          const BASE_URL = __ENV.TARGET_URL || 'http://localhost:4000';

          export default function () {
            // Health check
            let res = http.get(`${BASE_URL}/api/health`);
            check(res, {
              'health check status 200': (r) => r.status === 200,
              'health check has uptime': (r) => JSON.parse(r.body).uptime > 0,
            }) || errorRate.add(1);
            
            sleep(0.5);
            
            // Shipments list (requires auth - will fail gracefully)
            res = http.get(`${BASE_URL}/api/shipments`);
            check(res, {
              'shipments endpoint responds': (r) => r.status === 200 || r.status === 401,
            }) || errorRate.add(1);
            
            sleep(1);
          }

          export function handleSummary(data) {
            return {
              'load-test-summary.json': JSON.stringify(data),
              stdout: textSummary(data, { indent: ' ', enableColors: true }),
            };
          }

          function textSummary(data, options) {
            const indent = options?.indent || '';
            const lines = [];
            
            lines.push(indent + 'âœ“ Load Test Summary (' + TEST_TYPE.toUpperCase() + ')');
            lines.push(indent + 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            lines.push(indent + `Duration: ${data.state.testRunDurationMs / 1000}s`);
            lines.push(indent + `Requests: ${data.metrics.http_reqs.values.count}`);
            lines.push(indent + `Failed: ${data.metrics.http_req_failed.values.rate * 100}%`);
            lines.push(indent + `Avg Response: ${data.metrics.http_req_duration.values.avg.toFixed(2)}ms`);
            lines.push(indent + `P95 Response: ${data.metrics.http_req_duration.values['p(95)'].toFixed(2)}ms`);
            lines.push(indent + `P99 Response: ${data.metrics.http_req_duration.values['p(99)'].toFixed(2)}ms`);
            
            return lines.join('\n');
          }
          EOF

          # Replace DURATION placeholder
          sed -i "s/\${DURATION}/${{ inputs.duration }}/g" load-test.js

      - name: Run k6 load test
        id: k6
        run: |
          k6 run \
            --env TARGET_URL=${{ steps.target.outputs.url }} \
            --env VUS=${{ inputs.vus }} \
            --out json=load-test-results.json \
            load-test.js
        continue-on-error: true

      - name: Parse results
        if: always()
        run: |
          if [ -f load-test-summary.json ]; then
            echo "### ğŸ“Š Load Test Results (${{ inputs.test_type }} Test)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Environment:** ${{ inputs.target_env }}" >> $GITHUB_STEP_SUMMARY
            echo "**Test Type:** ${{ inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
            echo "**Duration:** ${{ inputs.duration }}s" >> $GITHUB_STEP_SUMMARY
            echo "**Virtual Users:** ${{ inputs.vus }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract key metrics using jq
            REQUESTS=$(jq -r '.metrics.http_reqs.values.count' load-test-summary.json)
            FAIL_RATE=$(jq -r '.metrics.http_req_failed.values.rate * 100' load-test-summary.json)
            AVG_DURATION=$(jq -r '.metrics.http_req_duration.values.avg' load-test-summary.json)
            P95_DURATION=$(jq -r '.metrics["http_req_duration"].values["p(95)"]' load-test-summary.json)
            P99_DURATION=$(jq -r '.metrics["http_req_duration"].values["p(99)"]' load-test-summary.json)
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Requests | $REQUESTS |" >> $GITHUB_STEP_SUMMARY
            echo "| Failure Rate | ${FAIL_RATE}% |" >> $GITHUB_STEP_SUMMARY
            echo "| Avg Response Time | ${AVG_DURATION}ms |" >> $GITHUB_STEP_SUMMARY
            echo "| P95 Response Time | ${P95_DURATION}ms |" >> $GITHUB_STEP_SUMMARY
            echo "| P99 Response Time | ${P99_DURATION}ms |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Check thresholds
            if (( $(echo "$FAIL_RATE > 5" | bc -l) )); then
              echo "âŒ **FAIL:** Error rate exceeds 5% threshold" >> $GITHUB_STEP_SUMMARY
              exit 1
            elif (( $(echo "$P95_DURATION > 500" | bc -l) )); then
              echo "âš ï¸ **WARNING:** P95 response time exceeds 500ms target" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **PASS:** All thresholds met" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload results artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results-${{ inputs.target_env }}
          path: |
            load-test-results.json
            load-test-summary.json
          retention-days: 30

      - name: Comment on PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('load-test-summary.json')) {
              const summary = JSON.parse(fs.readFileSync('load-test-summary.json'));
              const requests = summary.metrics.http_reqs.values.count;
              const failRate = (summary.metrics.http_req_failed.values.rate * 100).toFixed(2);
              const avgDuration = summary.metrics.http_req_duration.values.avg.toFixed(2);
              const p95 = summary.metrics.http_req_duration.values['p(95)'].toFixed(2);
              
              const comment = `### ğŸ“Š Load Test Results
              
              **Environment:** ${{ inputs.target_env }}
              **Duration:** ${{ inputs.duration }}s
              **Virtual Users:** ${{ inputs.vus }}
              
              | Metric | Value |
              |--------|-------|
              | Total Requests | ${requests} |
              | Failure Rate | ${failRate}% |
              | Avg Response Time | ${avgDuration}ms |
              | P95 Response Time | ${p95}ms |
              
              ${failRate > 5 ? 'âŒ Error rate exceeds threshold' : 'âœ… Performance acceptable'}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
