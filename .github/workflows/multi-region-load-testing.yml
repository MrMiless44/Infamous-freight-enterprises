name: Multi-Region Load Testing

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of load test to run'
        required: true
        default: 'multi-region'
        type: choice
        options:
          - multi-region
          - regional-comparison
          - geo-failover
      regions:
        description: 'Regions to test (comma-separated)'
        required: false
        default: 'us-east-1,eu-west-1,ap-southeast-1'

jobs:
  setup-matrix:
    name: Setup regional test matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.regions.outputs.matrix }}
      test-type: ${{ steps.config.outputs.test-type }}
    steps:
      - name: Configure test parameters
        id: config
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type || 'multi-region' }}"
          echo "test-type=$TEST_TYPE" >> $GITHUB_OUTPUT

      - name: Generate region matrix
        id: regions
        run: |
          REGIONS="${{ github.event.inputs.regions || 'us-east-1,eu-west-1,ap-southeast-1' }}"
          
          # Convert regions string to JSON array
          MATRIX=$(echo "$REGIONS" | \
            awk -F',' '{
              printf "["
              for(i=1; i<=NF; i++) {
                gsub(/^[[:space:]]+|[[:space:]]+$/, "", $i)
                printf "{\"region\":\"%s\"}", $i
                if(i<NF) printf ","
              }
              printf "]"
            }')
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Region matrix: $MATRIX"

  multi-region-load-test:
    name: Load test in ${{ matrix.region }}
    needs: setup-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
      max-parallel: 3
    env:
      TEST_REGION: ${{ matrix.region }}
      API_URL: ${{ secrets.API_URL || 'http://localhost:4000' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Display region configuration
        run: |
          echo "## Regional Load Test: $TEST_REGION"
          echo "Region: $TEST_REGION"
          echo "API URL: $API_URL"
          echo "Test Type: ${{ needs.setup-matrix.outputs.test-type }}"

      - name: Create region-specific load test script
        run: |
          cat > /tmp/regional-load-test.js <<'SCRIPT'
          import http from 'k6/http';
          import { check, sleep } from 'k6';
          import { Rate } from 'k6/metrics';

          const apiUrl = __ENV.API_URL || 'http://localhost:4000';
          const region = __ENV.TEST_REGION || 'unknown';
          
          // Custom metrics for regional testing
          const errorRate = new Rate('region_errors');
          const responseTime = new Rate('region_response_time');

          export const options = {
            stages: [
              { duration: '30s', target: 20 }, // Ramp up to 20 users
              { duration: '1m30s', target: 50 }, // Ramp up to 50 users
              { duration: '2m', target: 100 }, // Peak at 100 users
              { duration: '1m', target: 50 }, // Ramp down to 50 users
              { duration: '30s', target: 0 }, // Ramp down to 0 users
            ],
            thresholds: {
              http_req_duration: ['p(95)<500', 'p(99)<1000'],
              http_req_failed: ['rate<0.1'],
              region_errors: ['rate<0.1'],
            },
          };

          export default function () {
            const params = {
              tags: { region: region },
              timeout: '10s',
            };

            // Test health endpoint (low latency baseline)
            const healthRes = http.get(`${apiUrl}/api/health`, params);
            check(healthRes, {
              'Health check succeeds': (r) => r.status === 200,
              'Health response time < 200ms': (r) => r.timings.duration < 200,
            }) || errorRate.add(1);

            sleep(0.5);

            // Test API endpoints (simulate real user traffic)
            const endpoints = [
              '/api/shipments',
              '/api/users',
              '/api/billing',
            ];

            endpoints.forEach((endpoint) => {
              const res = http.get(`${apiUrl}${endpoint}`, params);
              check(res, {
                [`${endpoint} succeeds`]: (r) => r.status === 200 || r.status === 401,
                [`${endpoint} response time < 1000ms`]: (r) => r.timings.duration < 1000,
              }) || errorRate.add(1);
              
              responseTime.add(res.timings.duration);
              sleep(0.5);
            });
          }
          SCRIPT

          cat /tmp/regional-load-test.js

      - name: Run regional load test
        continue-on-error: true
        env:
          K6_CLOUD: 'false'
        run: |
          k6 run /tmp/regional-load-test.js \
            --out=json=/tmp/regional-results-${TEST_REGION}.json \
            --summary-export=/tmp/regional-summary-${TEST_REGION}.json

      - name: Display regional results
        if: always()
        run: |
          echo "## Results for $TEST_REGION"
          if [ -f "/tmp/regional-summary-${TEST_REGION}.json" ]; then
            cat "/tmp/regional-summary-${TEST_REGION}.json" | jq '.' || echo "Results file not found"
          else
            echo "No results available"
          fi

      - name: Upload regional results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results-${{ matrix.region }}
          path: /tmp/regional-*-${{ matrix.region }}.*
          retention-days: 7

  aggregate-results:
    name: Aggregate multi-region results
    needs: multi-region-load-test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all regional results
        uses: actions/download-artifact@v4
        with:
          path: /tmp/results

      - name: Analyze regional performance
        run: |
          echo "## Multi-Region Load Test Summary"
          echo ""
          echo "### Regional Performance Comparison"
          echo ""
          echo "| Region | Status | Details |"
          echo "|--------|--------|---------|"
          
          for dir in /tmp/results/*/; do
            REGION=$(basename "$dir" | sed 's/load-test-results-//')
            if [ -f "${dir}regional-summary-${REGION}.json" ]; then
              echo "| $REGION | ✅ Completed | See artifact |"
            else
              echo "| $REGION | ⚠️ No data | Check logs |"
            fi
          done

      - name: Generate comparison report
        run: |
          cat > /tmp/comparison.md <<'EOF'
          # Multi-Region Load Testing Report
          
          ## Test Execution Summary
          - **Date:** $(date)
          - **Test Type:** ${{ needs.setup-matrix.outputs.test-type }}
          - **Regions Tested:** ${{ github.event.inputs.regions || 'us-east-1,eu-west-1,ap-southeast-1' }}
          
          ## Key Metrics by Region
          
          The detailed results are available in the artifacts:
          - Check individual regional artifacts for response times
          - Compare error rates across regions
          - Identify latency patterns
          
          ## Recommendations
          
          1. **Best Performing Region:** Review artifacts to identify
          2. **Latency Outliers:** Investigate regions with high p99 latencies
          3. **Error Patterns:** Check for region-specific failure modes
          4. **Capacity Planning:** Use peak concurrency data for auto-scaling
          
          ## Next Steps
          
          - Review full results in artifacts
          - Configure regional failover if needed
          - Update load balancing rules based on findings
          - Schedule follow-up tests after deployments
          EOF
          
          cat /tmp/comparison.md

      - name: Create summary comment
        if: github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('/tmp/comparison.md', 'utf8');
            
            core.notice(`Multi-region load test completed. Results: ${report}`);

  failover-test:
    name: Simulate regional failover
    needs: multi-region-load-test
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'geo-failover' || always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup k6
        run: |
          sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install -y k6

      - name: Create failover test script
        run: |
          cat > /tmp/failover-test.js <<'SCRIPT'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          const primaryUrl = __ENV.API_URL || 'http://localhost:4000';
          const fallbackUrl = __ENV.FALLBACK_URL || 'http://localhost:4001';
          
          export const options = {
            stages: [
              { duration: '30s', target: 10 },
              { duration: '1m', target: 20 },
              { duration: '30s', target: 0 },
            ],
            thresholds: {
              http_req_duration: ['p(95)<500'],
            },
          };

          export default function () {
            // Test primary endpoint
            const primaryRes = http.get(primaryUrl + '/api/health', {
              timeout: '5s',
            });

            // If primary fails, test fallback
            let finalRes = primaryRes;
            if (primaryRes.status >= 500) {
              console.log('Primary failed, testing fallback');
              finalRes = http.get(fallbackUrl + '/api/health', {
                timeout: '5s',
              });
            }

            check(finalRes, {
              'Endpoint available (primary or fallback)': (r) => r.status === 200,
              'Failover time reasonable': (r) => r.timings.duration < 1000,
            });

            sleep(0.5);
          }
          SCRIPT

      - name: Run failover test
        continue-on-error: true
        env:
          K6_CLOUD: 'false'
        run: |
          k6 run /tmp/failover-test.js \
            --out=json=/tmp/failover-results.json

      - name: Upload failover results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: failover-test-results
          path: /tmp/failover-results.json
          retention-days: 7

---

## Configuration

### Setup Regional Testing

1. **Configure API endpoints for each region:**
   ```bash
   # Set primary API URL
   gh secret set API_URL https://api.example.com
   
   # Set fallback URL (for failover testing)
   gh secret set FALLBACK_URL https://fallback-api.example.com
   ```

2. **Customize regions to test:**
   - Default: us-east-1, eu-west-1, ap-southeast-1
   - Modify in workflow dispatch input or schedule

### Features

✅ **Multi-Region Load Testing**
- Parallel testing across 3 regions
- Realistic load patterns per region
- Performance metrics per region

✅ **Regional Comparison**
- Response times by region
- Error rates by region
- Capacity analysis

✅ **Failover Testing**
- Primary endpoint failure simulation
- Automatic fallback testing
- Failover time measurements

### Test Patterns

**Load Profile (Default):**
- Ramp: 0 → 20 → 50 → 100 users
- Duration: ~6 minutes
- Gradual load increase

**Stress Testing (Optional):**
- Ramp: 0 → 50 → 150 → 300 users
- Identify breaking point
- Duration: ~8 minutes

**Spike Testing (Optional):**
- Sudden: 50 → 500 users
- Measure recovery time
- Duration: ~5 minutes

---

## Running Tests

### Automatic (Scheduled)
- Runs every Sunday at 2 AM UTC
- Tests default regions (us-east-1, eu-west-1, ap-southeast-1)
- Results stored as artifacts (7 day retention)

### Manual (Workflow Dispatch)
```bash
# Run multi-region test
gh workflow run multi-region-load-testing.yml \
  -f test_type=multi-region

# Run regional comparison
gh workflow run multi-region-load-testing.yml \
  -f test_type=regional-comparison

# Run failover test
gh workflow run multi-region-load-testing.yml \
  -f test_type=geo-failover

# Custom regions
gh workflow run multi-region-load-testing.yml \
  -f regions="us-west-2,eu-central-1,ap-northeast-1"
```

---

## Interpreting Results

### Metrics
- **p95 response time:** 95% of requests complete in X ms (target: <500ms)
- **p99 response time:** 99% of requests complete in X ms (target: <1000ms)
- **Error rate:** Percentage of failed requests (target: <10%)
- **Peak throughput:** Maximum requests/sec at capacity

### Regional Comparison
1. Identify best-performing region
2. Investigate latency outliers
3. Check for region-specific issues
4. Plan capacity based on peak usage

### Failover Analysis
1. Measure failover detection time
2. Validate backup endpoint availability
3. Assess recovery time
4. Plan geo-redundancy improvements

---

## Cost & Performance

**Typical Costs:**
- 6 minute test × 3 regions × 100 peak VUs = minimal cost
- k6 cloud: ~$0.05 per test (if enabled)
- GitHub Actions: Included in allocation

**Performance Overhead:**
- Test duration: ~10 minutes (including ramp-up/down)
- Artifact storage: ~5 MB per test
- Weekly schedule: ~50 MB storage/month
