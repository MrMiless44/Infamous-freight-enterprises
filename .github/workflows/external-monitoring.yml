name: External Monitoring Integration

on:
  workflow_run:
    workflows:
      - CI/CD
      - E2E Tests
      - Deploy to Render
      - Deploy to Vercel
    types:
      - completed

permissions:
  contents: read
  checks: read

jobs:
  datadog-integration:
    name: Send metrics to Datadog
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'skipped'
    steps:
      - name: Extract workflow data
        id: workflow-data
        run: |
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "conclusion=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
          echo "run_number=${{ github.event.workflow_run.run_number }}" >> $GITHUB_OUTPUT
          echo "duration=${{ github.event.workflow_run.run_number }}" >> $GITHUB_OUTPUT

      - name: Send to Datadog (if configured)
        if: env.DD_API_KEY != '' && env.DD_SITE != ''
        run: |
          curl -X POST "https://api.${DD_SITE}/api/v1/series" \
            -H "DD-API-KEY: ${DD_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "series": [
              {
                "metric": "ci.workflow.completion",
                "points": [[$(date +%s), 1]],
                "type": "gauge",
                "tags": [
                  "workflow:${{ steps.workflow-data.outputs.workflow_name }}",
                  "conclusion:${{ steps.workflow-data.outputs.conclusion }}",
                  "run_number:${{ steps.workflow-data.outputs.run_number }}"
                ]
              }
            ]
          }
          EOF
        env:
          DD_API_KEY: ${{ secrets.DATADOG_API_KEY }}
          DD_SITE: ${{ secrets.DATADOG_SITE }}

  sentry-integration:
    name: Send error events to Sentry
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Send to Sentry (if configured)
        if: env.SENTRY_DSN != ''
        run: |
          curl -X POST "$SENTRY_DSN/store/" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "event_id": "$(uuidgen)",
            "message": "GitHub Actions workflow failed",
            "level": "error",
            "platform": "other",
            "contexts": {
              "workflow": {
                "name": "${{ github.event.workflow_run.name }}",
                "run_number": "${{ github.event.workflow_run.run_number }}",
                "repository": "${{ github.repository }}",
                "branch": "${{ github.ref_name }}"
              }
            },
            "tags": {
              "workflow": "${{ github.event.workflow_run.name }}",
              "repository": "${{ github.repository }}"
            },
            "fingerprint": [
              "{{ default }}",
              "${{ github.event.workflow_run.name }}"
            ]
          }
          EOF
        env:
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}

  newrelic-integration:
    name: Send metrics to New Relic
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'skipped'
    steps:
      - name: Prepare New Relic metrics
        id: metrics
        run: |
          echo "timestamp=$(date +%s)000" >> $GITHUB_OUTPUT

      - name: Send to New Relic (if configured)
        if: env.NEW_RELIC_API_KEY != ''
        run: |
          curl -X POST "https://metric-api.newrelic.com/metric/api/v1/write" \
            -H "Api-Key: ${NEW_RELIC_API_KEY}" \
            -H "Content-Type: application/json" \
            -d @- <<EOF
          {
            "metrics": [
              {
                "name": "ci.workflow.completion",
                "type": "gauge",
                "value": 1,
                "timestamp": ${{ steps.metrics.outputs.timestamp }},
                "attributes": {
                  "workflow": "${{ github.event.workflow_run.name }}",
                  "conclusion": "${{ github.event.workflow_run.conclusion }}",
                  "repository": "${{ github.repository }}"
                }
              }
            ]
          }
          EOF
        env:
          NEW_RELIC_API_KEY: ${{ secrets.NEW_RELIC_API_KEY }}

  send-notification:
    name: Send workflow status notification
    runs-on: ubuntu-latest
    if: always() && github.event.workflow_run.conclusion != 'skipped'
    needs: [datadog-integration, sentry-integration, newrelic-integration]
    steps:
      - name: Generate notification
        id: notification
        run: |
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          if [ "$CONCLUSION" = "success" ]; then
            EMOJI="✅"
            COLOR="green"
          elif [ "$CONCLUSION" = "failure" ]; then
            EMOJI="❌"
            COLOR="red"
          else
            EMOJI="⚠️"
            COLOR="yellow"
          fi
          
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT

      - name: Log notification summary
        run: |
          echo "Workflow: ${{ github.event.workflow_run.name }}"
          echo "Conclusion: ${{ github.event.workflow_run.conclusion }}"
          echo "Status: ${{ steps.notification.outputs.emoji }}"

---

## Configuration

To enable external monitoring:

1. **Datadog Integration:**
   ```bash
   gh secret set DATADOG_API_KEY
   gh secret set DATADOG_SITE
   ```
   - DATADOG_SITE: `datadoghq.com` or `datadoghq.eu`

2. **Sentry Integration:**
   ```bash
   gh secret set SENTRY_DSN
   ```
   - Get DSN from Sentry project settings

3. **New Relic Integration:**
   ```bash
   gh secret set NEW_RELIC_API_KEY
   ```
   - Get API key from New Relic account

---

## Metrics Sent

### Datadog
- `ci.workflow.completion` - Workflow completion status
- Tags: workflow name, conclusion, run number

### Sentry
- Failure events with context
- Workflow name and run details
- Repository and branch information

### New Relic
- Workflow completion metrics
- Custom attributes for filtering

---

## Verification

Monitor in your external service:

**Datadog:**
```
Logs → ci.workflow.* → Filter by workflow name
```

**Sentry:**
```
Issues → Filter by "workflow" tag
```

**New Relic:**
```
Metrics → ci.workflow.completion
```
