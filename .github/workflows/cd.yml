name: CD

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "archive/**"
      - "docs/**"
      - "**.md"
      - ".vscode/**"
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Run CI checks first before deploying
  ci:
    name: CI Checks
    uses: ./.github/workflows/ci.yml

  check-secrets:
    name: Check deployment secrets
    runs-on: ubuntu-latest
    outputs:
      has-fly-token: ${{ steps.check.outputs.has-fly-token }}
      has-vercel-token: ${{ steps.check.outputs.has-vercel-token }}
    steps:
      - name: Check secrets
        id: check
        run: |
          if [ -n "${{ secrets.FLY_API_TOKEN }}" ]; then
            echo "has-fly-token=true" >> $GITHUB_OUTPUT
          else
            echo "has-fly-token=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ FLY_API_TOKEN not configured, skipping Fly.io deployment"
          fi
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "has-vercel-token=true" >> $GITHUB_OUTPUT
          else
            echo "has-vercel-token=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ VERCEL_TOKEN not configured, skipping Vercel deployment"
          fi

  deploy-api:
    name: Deploy API to Fly.io
    needs: [ci, check-secrets]
    if: needs.check-secrets.outputs.has-fly-token == 'true'
    uses: ./.github/workflows/fly-deploy.yml
    secrets: inherit

  deploy-web:
    name: Deploy Web to Vercel
    needs: [ci, check-secrets]
    if: needs.check-secrets.outputs.has-vercel-token == 'true'
    uses: ./.github/workflows/vercel-deploy.yml
    secrets: inherit

  notify-success:
    name: Deployment Success
    needs: [deploy-api, deploy-web]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Report status
        run: |
          echo "## ðŸš€ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- API Status: ${{ needs.deploy-api.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Web Status: ${{ needs.deploy-web.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.deploy-api.result }}" = "success" ]; then
            echo "âœ… API deployed to Fly.io" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.deploy-web.result }}" = "success" ]; then
            echo "âœ… Web deployed to Vercel" >> $GITHUB_STEP_SUMMARY
          fi
