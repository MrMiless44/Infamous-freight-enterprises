name: Reusable Test Workflow

on:
  workflow_call:
    inputs:
      package-name:
        required: true
        type: string
        description: "Package name to test (e.g., infamous-freight-api, infamous-freight-web)"
      node-version:
        required: false
        type: string
        default: "20"
        description: "Node.js version to use"
      working-directory:
        required: false
        type: string
        default: "."
        description: "Working directory for tests"
      test-command:
        required: false
        type: string
        default: "test"
        description: "Test command to run"
      coverage-enabled:
        required: false
        type: boolean
        default: true
        description: "Whether to generate coverage reports"
      postgres-required:
        required: false
        type: boolean
        default: false
        description: "Whether PostgreSQL service is needed"
      redis-required:
        required: false
        type: boolean
        default: false
        description: "Whether Redis service is needed"

jobs:
  test:
    name: Test ${{ inputs.package-name }}
    runs-on: ubuntu-latest
    services:
      postgres:
        image: ${{ inputs.postgres-required && 'postgres:15-alpine' || '' }}
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: ${{ inputs.redis-required && 'redis:7-alpine' || '' }}
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.9

      - name: Setup pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: pnpm

      - name: Install dependencies
        env:
          HUSKY: 0
        run: pnpm install --frozen-lockfile

      - name: Build shared package (if needed)
        run: pnpm --filter @infamous-freight/shared build || echo "No shared package"
        continue-on-error: true

      - name: Setup test database
        if: inputs.postgres-required
        env:
          DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db
        run: |
          cd ${{ inputs.working-directory }}
          pnpm prisma migrate deploy || true
          pnpm prisma generate || true

      - name: Run tests
        working-directory: ${{ inputs.working-directory }}
        env:
          DATABASE_URL: ${{ inputs.postgres-required && 'postgresql://postgres:test_password@localhost:5432/test_db' || '' }}
          REDIS_URL: ${{ inputs.redis-required && 'redis://localhost:6379' || '' }}
          JWT_SECRET: test-secret-key-for-ci
          NODE_ENV: test
          API_PORT: 4000
          CORS_ORIGINS: http://localhost:3000
          AI_PROVIDER: synthetic
        run: pnpm --filter ${{ inputs.package-name }} ${{ inputs.test-command }}

      - name: Upload coverage (if enabled)
        if: inputs.coverage-enabled
        uses: codecov/codecov-action@v3
        with:
          files: ${{ inputs.working-directory }}/coverage/coverage-final.json
          flags: ${{ inputs.package-name }}
          name: ${{ inputs.package-name }}-coverage
        continue-on-error: true

      - name: Publish test summary
        if: always()
        run: |
          echo "## ✅ Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Package** | \`${{ inputs.package-name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Node Version** | ${{ inputs.node-version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Coverage** | ${{ inputs.coverage-enabled && 'Enabled' || 'Disabled' }} |" >> $GITHUB_STEP_SUMMARY
