name: Deploy Web to Vercel

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy Web to Vercel
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment:
      name: production-vercel
      url: https://infamous-freight-enterprises.vercel.app
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "pnpm"

      - name: Install dependencies
        env:
          HUSKY: 0
        run: pnpm install --frozen-lockfile

      - name: Verify secrets
        id: verify
        run: |
          if [ -z "${{ secrets.VERCEL_TOKEN }}" ]; then
            echo "âŒ VERCEL_TOKEN secret not configured"
            exit 1
          fi
          echo "secrets_ok=true" >> $GITHUB_OUTPUT

      - name: Build shared package
        run: pnpm --filter @infamous-freight/shared build || echo "No shared package build needed"
        continue-on-error: true

      - name: Pull Vercel Environment Information
        id: vercel-env
        run: npx vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        continue-on-error: true

      - name: Build Project
        id: build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'https://api.example.com' }}
        run: npx vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        id: deploy
        run: |
          DEPLOY_URL=$(npx vercel deploy --prod --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployed to: $DEPLOY_URL"

      - name: Wait for deployment
        run: sleep 10

      - name: Health check
        id: health
        run: |
          MAX_RETRIES=5
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://infamous-freight-enterprises.vercel.app)
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Web app is healthy (HTTP $HTTP_CODE)"
              echo "health=ok" >> $GITHUB_OUTPUT
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "â³ Attempt $RETRY_COUNT/$MAX_RETRIES - HTTP $HTTP_CODE"
            sleep 3
          done
          echo "âš ï¸  Health check failed"
          echo "health=timeout" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Publish deployment summary
        run: |
          echo "## ðŸš€ Web Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Vercel Deployment** | âœ… Complete |" >> $GITHUB_STEP_SUMMARY
          echo "| **Health Check** | ${{ steps.health.outputs.health }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Web URL** | https://infamous-freight-enterprises.vercel.app |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Status** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Vercel Dashboard](https://vercel.com/dashboard)" >> $GITHUB_STEP_SUMMARY
        if: always()

      - name: Create GitHub Deployment Status
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const deploymentState = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 1,
              state: deploymentState,
              environment_url: 'https://infamous-freight-enterprises.vercel.app',
              description: deploymentState === 'success' ? 'Web deployment successful' : 'Web deployment failed'
            });

      - name: Comment on PR with Deployment Info
        uses: actions/github-script@v7
        if: github.event_name == 'push' && always()
        with:
          script: |
            const fs = require('fs');
            const commits = context.payload.commits || [];
            const latestCommit = commits[commits.length - 1];
            const status = '${{ job.status }}' === 'success' ? 'âœ…' : 'âŒ';
            
            const comment = `## ${status} Web Deployment to Vercel
            
**Build Status:** ${{ job.status }}
**Commit:** [\`${context.sha.substring(0, 7)}\`](${latestCommit?.url || '#'})
**Author:** ${latestCommit?.author.name || 'Unknown'}

### Deployment Details
- **Environment:** Production
- **URL:** https://infamous-freight-enterprises.vercel.app
- **Health Check:** ${{ steps.health.outputs.health }}
- **Timestamp:** ${new Date().toISOString()}

${status === 'âœ…' ? 'âœ¨ **Web deployment successful!**' : 'âš ï¸ **Web deployment failed. Check logs above.**'}`;
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 1
            });
            
            if (pullRequests.length > 0) {
              github.rest.issues.createComment({
                issue_number: pullRequests[0].number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
