name: Deploy Web to Vercel

on:
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ secrets.VERCEL_TOKEN != '' }}
    permissions:
      contents: read
      deployments: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "pnpm"
      - name: Install dependencies
        env:
          HUSKY: 0
        run: pnpm -w install --frozen-lockfile
      - name: Lint web
        run: pnpm --filter web lint
        continue-on-error: true
      - name: Generate Prisma client
        run: pnpm --filter infamous-freight-api exec prisma generate
        continue-on-error: true
      - name: Pull Vercel Environment Information
        run: npx vercel pull --yes --environment=production --token=${{
          secrets.VERCEL_TOKEN }}
      - name: Build Project
        run: npx vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      - name: Deploy to Vercel
        run: npx vercel deploy --prod --prebuilt --token=${{
          secrets.VERCEL_TOKEN }}
      - name: Deployment Complete
        if: always()
        run: |
          echo "âœ… Vercel Deployment: ${{ job.status }}"
          echo "ðŸ“ URL: https://infamous-freight-enterprises-git-f34b9b-santorio-miles-projects.vercel.app"

      - name: Create GitHub Deployment Status
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const deploymentState = '${{ job.status }}' === 'success' ? 'success' : 'failure';
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 1,
              state: deploymentState,
              environment_url: 'https://infamous-freight-enterprises-git-f34b9b-santorio-miles-projects.vercel.app',
              description: deploymentState === 'success' ? 'Deployment successful' : 'Deployment failed'
            });

      - name: Comment on PR with Deployment Info
        uses: actions/github-script@v7
        if: github.event_name == 'push' && always()
        with:
          script: |
            const fs = require('fs');
            const commits = context.payload.commits || [];
            const latestCommit = commits[commits.length - 1];
            const status = '${{ job.status }}' === 'success' ? 'âœ…' : 'âŒ';
            
            const comment = `## ${status} Deployment to Vercel
            
**Build Status:** ${{ job.status }}
**Commit:** [\`${context.sha.substring(0, 7)}\`](${latestCommit?.url || '#'})
**Author:** ${latestCommit?.author.name || 'Unknown'}

### Deployment Details
- **Environment:** Production
- **URL:** https://infamous-freight-enterprises-git-f34b9b-santorio-miles-projects.vercel.app
- **Timestamp:** ${new Date().toISOString()}

${status === 'âœ…' ? 'âœ¨ **Deployment successful!**' : 'âš ï¸ **Deployment failed. Check logs above.**'}`;
            
            // Only comment if we can find a related PR
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 1
            });
            
            if (pullRequests.length > 0) {
              github.rest.issues.createComment({
                issue_number: pullRequests[0].number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
