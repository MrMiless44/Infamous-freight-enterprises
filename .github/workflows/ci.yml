name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.9
          run_install: false

      - uses: actions/setup-node@v4
        with:
          node-version: 20.18.1
          cache: pnpm

      - name: Show repo tree (for debugging)
        run: |
          echo "::group::Repository Tree"
          echo "Repository structure for debugging:"
          if command -v tree >/dev/null 2>&1; then
            tree -L 4 || true
          else
            ls -R || true
          fi
          echo "::endgroup::"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs
          path: |
            ./*.log
            ./src/apps/api/**/*.log
            ./src/apps/web/**/*.log
            ./src/apps/mobile/**/*.log
            ./tests/e2e/**/*.log
            ./logs/**/*.log
            ./*.txt
            ./src/apps/api/**/*.txt
            ./src/apps/web/**/*.txt
            ./src/apps/mobile/**/*.txt
            ./tests/e2e/**/*.txt
            ./logs/**/*.txt
            !**/node_modules/**
            !**/dist/**
            !**/.next/**
            !**/build/**

      - name: Install (monorepo)
        run: pnpm install --frozen-lockfile

      - name: Validate source files (HTML, CSS, JS/TS)
        run: pnpm validate

      - name: Lint (workspace)
        run: pnpm lint

      - name: Typecheck (if present)
        run: pnpm -r --if-present run typecheck

      - name: Test
        run: pnpm test

      - name: Coverage (if present)
        run: pnpm test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: |
            coverage/**/lcov.info
            src/apps/**/coverage/lcov.info
          fail_ci_if_error: true
          verbose: true
