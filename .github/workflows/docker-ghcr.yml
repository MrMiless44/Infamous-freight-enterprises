name: Build and Push Docker Images to GHCR

on:
  push:
    branches: [main]
    tags: ["v*", "*.*.*"]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  pull-requests: write
  security-events: write
  id-token: write

jobs:
  build-and-push:
    name: Build & Push (${{ matrix.service }})
    runs-on: ubuntu-latest
    concurrency:
      group: ghcr-${{ github.ref }}-${{ matrix.service }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      matrix:
        service: [api, web]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Read service version
        id: svcver
        run: |
          FILE="${{ matrix.service }}/package.json"
          if [ -f "$FILE" ]; then
            VERSION=$(node -p "require('./${{ matrix.service }}/package.json').version")
            echo "SERVICE_VERSION=$VERSION" >> $GITHUB_ENV
          else
            echo "SERVICE_VERSION=" >> $GITHUB_ENV
          fi

      - name: Compute extra tags
        run: |
          if [ -n "${{ env.SERVICE_VERSION }}" ]; then
            echo "EXTRA_TAGS=ghcr.io/${{ github.repository_owner }}/infamous-freight-enterprises-${{ matrix.service }}:v${{ env.SERVICE_VERSION }}" >> $GITHUB_ENV
          else
            echo "EXTRA_TAGS=" >> $GITHUB_ENV
          fi

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.repository_owner }}/infamous-freight-enterprises-${{ matrix.service }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=ref,event=tag
            type=sha
        env:
          SERVICE_VERSION: ${{ env.SERVICE_VERSION }}

      - name: Build and Push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.service }}
          file: ${{ matrix.service }}/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ steps.meta.outputs.tags }}
            ${{ env.EXTRA_TAGS }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: mode=max
          sbom: true

      - name: Output image tags
        run: |
          echo "Published: ${{ steps.meta.outputs.tags }}"

      - name: Trivy scan (CRITICAL/HIGH)
        if: ${{ steps.build.outputs.digest }}
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/infamous-freight-enterprises-${{ matrix.service }}@${{ steps.build.outputs.digest }}
          format: "sarif"
          output: trivy-${{ matrix.service }}-sarif.json
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
          exit-code: "1"

      - name: Upload Trivy SARIF to Security tab
        if: ${{ steps.build.outputs.digest }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-${{ matrix.service }}-sarif.json
          category: trivy-${{ matrix.service }}

      - name: Generate SBOM (CycloneDX)
        if: ${{ steps.build.outputs.digest }}
        uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/${{ github.repository_owner }}/infamous-freight-enterprises-${{ matrix.service }}@${{ steps.build.outputs.digest }}
          format: cyclonedx-json
          output-file: sbom-${{ matrix.service }}-${{ github.sha }}.cdx.json
          artifact-name: sbom-${{ matrix.service }}
          upload-artifact: true

      - name: Upload SBOM to Release (tag events)
        if: ${{ steps.build.outputs.digest && startsWith(github.ref, 'refs/tags/') }}
        uses: softprops/action-gh-release@v2
        with:
          files: sbom-${{ matrix.service }}-${{ github.sha }}.cdx.json

      - name: Install cosign
        if: ${{ steps.build.outputs.digest }}
        uses: sigstore/cosign-installer@v3

      - name: Sign image (keyless OIDC)
        if: ${{ steps.build.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes ghcr.io/${{ github.repository_owner }}/infamous-freight-enterprises-${{ matrix.service }}@${{ steps.build.outputs.digest }}

      - name: Attach SBOM attestation
        if: ${{ steps.build.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign attest --predicate sbom-${{ matrix.service }}-${{ github.sha }}.cdx.json --type cyclonedx ghcr.io/${{ github.repository_owner }}/infamous-freight-enterprises-${{ matrix.service }}@${{ steps.build.outputs.digest }}

      - name: Verify signature and attestation
        if: ${{ steps.build.outputs.digest }}
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign verify \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/docker-ghcr.yml@refs/heads/main" \
            ghcr.io/${{ github.repository_owner }}/infamous-freight-enterprises-${{ matrix.service }}@${{ steps.build.outputs.digest }}
          cosign verify-attestation \
            --type cyclonedx \
            --certificate-oidc-issuer "https://token.actions.githubusercontent.com" \
            --certificate-identity "https://github.com/${{ github.repository }}/.github/workflows/docker-ghcr.yml@refs/heads/main" \
            ghcr.io/${{ github.repository_owner }}/infamous-freight-enterprises-${{ matrix.service }}@${{ steps.build.outputs.digest }}

      - name: Grype scan (High/CRITICAL)
        if: ${{ steps.build.outputs.digest }}
        uses: anchore/scan-action@v3
        with:
          image: ghcr.io/${{ github.repository_owner }}/infamous-freight-enterprises-${{ matrix.service }}@${{ steps.build.outputs.digest }}
          fail-build: true
          severity-cutoff: high
          output-format: sarif
          sarif-file: grype-${{ matrix.service }}-sarif.json

      - name: Upload Grype SARIF to Security tab
        if: ${{ steps.build.outputs.digest }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: grype-${{ matrix.service }}-sarif.json
          category: grype-${{ matrix.service }}

  comment-digests:
    name: Comment aggregated digests to PR
    runs-on: ubuntu-latest
    needs: build-and-push
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'push' }}
    steps:
      - name: Download digest artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: digest-*
          merge-multiple: true
          path: digests

      - name: Compose combined body
        id: compose
        run: |
          echo "<!-- ghcr-digests -->" > digests/body.md
          echo "### Docker Image Digests" >> digests/body.md
          echo "" >> digests/body.md
          for f in digests/digest-*.txt; do
            echo "" >> digests/body.md
            cat "$f" >> digests/body.md || true
          done
          echo "BODY<<EOF" >> $GITHUB_OUTPUT
          cat digests/body.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post combined comment to PR
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const body = `${{ steps.compose.outputs.BODY }}`;
            async function upsertComment(prNumber) {
              const comments = await github.rest.issues.listComments({ owner, repo, issue_number: prNumber });
              const marker = '<!-- ghcr-digests -->';
              const existing = comments.data.find(c => c.user?.type === 'Bot' && c.body?.includes(marker));
              if (existing) {
                await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
              } else {
                await github.rest.issues.createComment({ owner, repo, issue_number: prNumber, body });
              }
            }
            if (context.eventName === 'pull_request') {
              const prNumber = context.payload.pull_request.number;
              await upsertComment(prNumber);
            } else if (context.eventName === 'push') {
              const commitSha = context.sha;
              const prs = await github.rest.repos.listPullRequestsAssociatedWithCommit({ owner, repo, commit_sha: commitSha });
              if (prs.data && prs.data.length > 0) {
                for (const pr of prs.data) {
                  await upsertComment(pr.number);
                }
              }
            }
      - name: Write digest artifact
        if: ${{ steps.build.outputs.digest }}
        run: |
          OWNER="${{ github.repository_owner }}"
          SERVICE="${{ matrix.service }}"
          DIGEST="${{ steps.build.outputs.digest }}"
          IMAGE="ghcr.io/${OWNER}/infamous-freight-enterprises-${SERVICE}@${DIGEST}"
          FILE="digest-${SERVICE}.txt"
          {
            echo "#### ${SERVICE}"
            echo ""
            echo "- Image: ${IMAGE}"
            echo "- Pull (by digest):"
            echo "  docker pull ghcr.io/${OWNER}/infamous-freight-enterprises-${SERVICE}@${DIGEST}"
            echo "- Verify signature:"
            echo "  COSIGN_EXPERIMENTAL=true cosign verify ghcr.io/${OWNER}/infamous-freight-enterprises-${SERVICE}@${DIGEST}"
            echo "- Verify SBOM attestation (CycloneDX):"
            echo "  COSIGN_EXPERIMENTAL=true cosign verify-attestation --type cyclonedx ghcr.io/${OWNER}/infamous-freight-enterprises-${SERVICE}@${DIGEST}"
          } > "$FILE"
          echo "Wrote $FILE"

      - name: Upload digest artifact
        if: ${{ steps.build.outputs.digest }}
        uses: actions/upload-artifact@v4
        with:
          name: digest-${{ matrix.service }}
          path: digest-${{ matrix.service }}.txt
